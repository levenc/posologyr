---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# posologyr

<!-- badges: start -->
<!-- badges: end -->

## Overview

`posologyr` is an R package for drug treatment individualisation, taking advantage of population pharmacokinetics (popPK), patient characteristics, and the results of therapeutic drug monitoring.

`posologyr` provides functions for estimating the pharmacokinetic (PK) parameters:

+ `poso_simu_pop()` for estimating the a priori distributions of popPK parameters by Monte-Carlo simulations
+ `poso_estim_map()` for computing the Maximum A Posteriori (MAP), aka Empirical Bayes Estimates (EBE), of individual PK parameters from the results of therapeutic drug monitoring
+ `poso_estim_mcmc()` for estimating the posterior distributions of individual PK parameters by Markov Chain Monte Carlo (MCMC)

Functions for dosage optimisation are included in `posologyr`:

+ `poso_time_cmin()` time needed to reach a target trough concentration (Cmin)
+ `poso_dose_auc()` optimal dose to reach a target AUC
+ `poso_dose_ctime()` optimal dose to reach a target concentration at any given time

Posologyr requires a popPK model written in the language of `RxODE`.

## Installation

You can install the development version of `posologyr` from [GitHub](https://github.com/) with:

``` r
# install.packages("devtools")
devtools::install_github("levenc/posologyr")
```

## Example

This example of bayesian dosage adaptation is based on a fictitious popPK model of tobramycin, and data of therapeutic drug monitoring.

Patient data (here: Michel's lab results) is organised in a dataframe following RxODE conventions.

```{r Michel}
library(posologyr)

df_michel <- data.frame(ID=1,TIME=c(0.0,0.5,1.0,14.0),
                        DV=c(NA,NA,25.0,5.5),
                        AMT=c(1000,-1000,0,0),
                        EVID=c(10102,10102,0,0),
                        DUR=c(0.5,0.5,NA,NA),
                        CLCREAT=80,WT=65)
df_michel
```

TIME is in hours, AMT is a rate in milligram/hour for the zero-order infusion of duration 0.5 hours: 500 mg of tobramycin are administered over 30 minutes.

The sample tobramycin prior model is supplied with `posologyr`. Following the same structure, user-defined models can be added.

The `load_ppk_model()` function initialises the objects to be used by `posologyr`. 

```{r load_ppk_model}
load_ppk_model(mod_tobramycin_2cpt_fictional,df_michel)
```

The estimates of the fixed effects parameters are available from the prior model.

```{r TV parameters}
prior_ppk_model$pk_prior$psi
```

The MAP estimates of the individual ETAs and PK parameters can be computed easily.

```{r MAP individual parameters}
poso_estim_map()
```

An optimal dose can be estimated to reach a concentration of 30 mg/l half an hour after the end of the infusion.

```{r optimal amount}
poso_dose_ctime(time_c = 1,duration = .5,target_conc = 30)
```

To further optimise the dosage, the time needed to reach a Cmin < 0.5 mg/l after an infusion of 620 mg over 30 minutes can be estimated.

```{r optimal dosing}
poso_time_cmin(dose = 620, duration = 0.5, target_cmin = 0.5)
```

As a result, the administration of 620 mg every 48 hours can be advisable for Michel.

## Sample plots

The RxODE model can be used to plot the individual PK profile.

```{r pop and MAP individual parameters, out.width = "70%"} 
library(ggplot2)

# compute the population and individual PK parameters
pop_pk              <- poso_simu_pop()[[2]]
indiv_pk_map        <- poso_estim_map()[[2]]
indiv_pk_mcmc       <- poso_estim_mcmc()[[2]]

# add sampling times
pop_pk$time         <- seq(0,24,by=0.2)
indiv_pk_map$time   <- seq(0,24,by=0.2)
indiv_pk_mcmc$time  <- seq(0,24,by=0.2)

# get the individual observations from df_michel
indiv_obs           <- dat_posologyr[,c("DV","TIME")]
```

Plot the distribution of the prior population PK profiles + individual observations.
```{r plot_pop_parameters, out.width = "70%"} 
names(indiv_obs)    <- c("eff","time")

plot(confint(pop_pk,"Cc", level=0.95),
     ylab="Central concentration") +
ggplot2::geom_point(data=indiv_obs, na.rm=TRUE)
```

Plot the individual MAP PK profile + individual observations.
```{r plot_MAP_individual_parameters, out.width = "70%"} 
names(indiv_obs)    <- c("value","time")

plot(indiv_pk_map,Cc) + 
  ggplot2::ylab("Central concentration") +
  ggplot2::geom_point(data=indiv_obs, na.rm=TRUE)
```

Plot the distribution of the individual PK profiles + individual observations.
```{r plot_posterior_individual_parameters, out.width = "70%"} 
names(indiv_obs)    <- c("eff","time")

plot(confint(indiv_pk_mcmc,"Cc", level=0.95),
     ylab="Central concentration") +
ggplot2::geom_point(data=indiv_obs, na.rm=TRUE)
```

## Acknowledgments
`posologyr` takes advantage of the simulation framework provided by the  [RxODE](https://github.com/nlmixrdevelopment/RxODE) package.

`posologyr`'s estimation functions were based on [Marc Lavielle's shiny app]( http://shiny.webpopix.org/mcmc/bayes1/)
